# 06 - Service Listings

## Objective

Enable tutors to define the services they sell—1:1 lessons, group classes (future), packages, and workshops—complete with pricing, descriptions, durations, and booking rules. These listings power the booking flow, Stripe payments, link-in-bio CTAs, and marketing funnels.

## Prerequisites

- ✅ **04-user-profiles.md** — Profile and business settings (currency, timezone) stored  
- ✅ **05-link-in-bio.md** — Marketing links ready to promote services  
- ✅ **01-database-schema.md** — `services`, `session_package_templates`, and related tables  
- ✅ **03-basic-dashboard.md** — Dashboard shell for management UI  
- Optional: seeded data in Supabase for testing availability/booking flows

## Deliverables

- `/app/(dashboard)/services/page.tsx` — overview list + create button  
- Service creation/edit form with validation (`react-hook-form`, `zod`)  
- Session package management (bundles tied to service)  
- Visibility toggles, featured tags, and Growth/Studio upsells  
- Public presentation components for profile and booking flows  
- Hooks for Stripe price sync to be implemented in **07-stripe-integration.md**

## UX Narrative

1. Tutor opens **Services** in dashboard → sees table of existing offerings, status, pricing.  
2. “New service” button launches multi-step form (Basics → Pricing → Policies → Packages).  
3. Form auto-fills duration, price currency from profile.  
4. On save, service appears in booking flow and link-in-bio.  
5. Tutor toggles availability, adds package bundles (10-session discount).  
6. Growth Plan CTA promotes upsell copy generator or upsell widget; Studio plan surfaces group sessions module.

## Implementation Steps

### Step 1: Route & Navigation

- Add `/services` entry in dashboard sidebar under “Run the Business.”  
- Create `/app/(dashboard)/services/page.tsx` (server component) to fetch user services.  
- Provide action buttons for create/edit/delete; consider `DataTable` (shadcn) for sorting/filtering.

```tsx
export default async function ServicesPage() {
  const supabase = await createClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()
  if (!user) return null

  const { data: services } = await supabase
    .from('services')
    .select('*')
    .eq('tutor_id', user.id)
    .order('sort_order', { ascending: true })

  return <ServiceDashboard services={services ?? []} />
}
```

### Step 2: Service Dashboard Component

```tsx
// components/services/service-dashboard.tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import { ServiceDialog } from './service-dialog'
import { ServicesTable } from './services-table'
import type { Service } from '@/lib/types'

export function ServiceDashboard({ services }: { services: Service[] }) {
  const [open, setOpen] = useState(false)

  return (
    <div className="space-y-6">
      <header className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold">Services</h1>
          <p className="text-sm text-muted-foreground">
            Create the offerings students can book. Pricing updates sync to Stripe.
          </p>
        </div>
        <Button onClick={() => setOpen(true)}>
          <Plus className="mr-2 h-4 w-4" />
          New service
        </Button>
      </header>

      <ServicesTable services={services} />

      <ServiceDialog open={open} onOpenChange={setOpen} />
    </div>
  )
}
```

### Step 3: Services Table

- Columns: Name, Duration, Price, Status (active/draft), Visibility toggle, Last updated.  
- Actions: Edit, Duplicate, Delete.  
- Display badges for `service_type` (1:1, group, workshop), `level` (A2, B1), `tags`.  
- Add `Switch` to toggle `is_active`.

### Step 4: Service Form Schema

```ts
// lib/validations/service.ts
import * as z from 'zod'

export const serviceSchema = z.object({
  name: z.string().min(3, 'Name is required'),
  slug: z.string().regex(/^[a-z0-9-]+$/),
  description: z.string().max(2000),
  service_type: z.enum(['one_on_one', 'group', 'workshop']),
  level: z.array(z.string()).optional(),
  duration_minutes: z.number().int().min(15),
  price_cents: z.number().int().min(0),
  currency: z.string().length(3),
  is_active: z.boolean().default(true),
  is_public: z.boolean().default(true),
  allow_trial: z.boolean().default(false),
  buffer_minutes_before: z.number().int().min(0).default(0),
  buffer_minutes_after: z.number().int().min(0).default(0),
  cancellation_policy: z.string().optional(),
  tags: z.array(z.string()).optional(),
  featured: z.boolean().default(false),
  color: z.string().optional(),
})
```

> For Growth Plan, you can add `upsell_copy` field generated by AI later.

### Step 5: Service Creation Dialog

Use multi-step form with `Accordion` or `Tabs`:

1. **Basics** — Name, description, service type, languages/levels.  
2. **Pricing** — Price, currency (default from profile), trial toggle, buffer times.  
3. **Presentation** — Featured toggle, highlight color, marketing copy.  
4. **Availability** (optional) — Link to availability page (08).  
5. **Packages** — Manage session bundles (see Step 6).

```tsx
// components/services/service-dialog.tsx
'use client'

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { serviceSchema } from '@/lib/validations/service'
import { z } from 'zod'
import { createService } from '@/lib/actions/services'
import { useTransition } from 'react'
import { toast } from 'sonner'

type ServiceValues = z.infer<typeof serviceSchema>

export function ServiceDialog({ open, onOpenChange, service }: Props) {
  const [isPending, startTransition] = useTransition()
  const form = useForm<ServiceValues>({
    resolver: zodResolver(serviceSchema),
    defaultValues: service ?? {
      currency: 'USD', // replace with profile default
      duration_minutes: 60,
    },
  })

  function onSubmit(values: ServiceValues) {
    startTransition(async () => {
      const { error } = service
        ? await updateService(service.id, values)
        : await createService(values)
      if (error) {
        toast.error(error)
        return
      }
      toast.success('Service saved')
      onOpenChange(false)
    })
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl">
        <DialogHeader>
          <DialogTitle>{service ? 'Edit service' : 'New service'}</DialogTitle>
        </DialogHeader>
        <form onSubmit={form.handleSubmit(onSubmit)} className="grid gap-6">
          {/* Tabs or accordions for steps */}
          <div className="flex justify-end gap-2">
            <Button type="button" variant="ghost" onClick={() => onOpenChange(false)}>
              Cancel
            </Button>
            <Button type="submit" disabled={isPending}>
              {service ? 'Save changes' : 'Create service'}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### Step 6: Session Packages Integration

- Nested section for `session_package_templates` tied to service.  
- Display existing packages in a list with price, session count, discount.  
- Provide `PackageDialog` to create/update bundles; automatically set `total_minutes = duration * count`.  
- Packages show up as add-ons in booking flow and Link-in-bio.

### Step 7: Server Actions for CRUD

```ts
// lib/actions/services.ts
'use server'

import { serviceSchema } from '@/lib/validations/service'
import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { z } from 'zod'

export async function createService(values: z.infer<typeof serviceSchema>) {
  const supabase = await createClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()
  if (!user) return { error: 'Not authenticated' }

  const parsed = serviceSchema.safeParse(values)
  if (!parsed.success) return { error: 'Invalid data' }

  const slug =
    parsed.data.slug ||
    parsed.data.name.toLowerCase().replace(/[^a-z0-9]+/g, '-')

  const { data, error } = await supabase
    .from('services')
    .insert({
      ...parsed.data,
      slug,
      tutor_id: user.id,
      price_cents: parsed.data.price_cents,
    })
    .select()
    .single()

  if (error) return { error: error.message }

  revalidatePath('/services')
  revalidatePath(`/@${slug}`) // update public profile
  return { data }
}
```

- `updateService` should ensure the service belongs to current user.  
- `deleteService` should soft delete or set `is_active = false` to keep historical bookings.  
- `updateServiceStatus` toggles `is_active` and revalidates caches.

### Step 8: Sync with Stripe Prices (Hook)

- When creating/updating service price, queue background job (Edge Function) that:  
  - Creates/updates Stripe `Product` and `Price`.  
  - Stores `stripe_price_id` on service record.  
- Outline instructions but actual implementation belongs to **07-stripe-integration.md**.  
- For now, mark service as `requires_stripe_sync = true`.

### Step 9: Availability & Buffer Integration

- On service save, check `availability` table for existing slots; prompt if missing.  
- Provide link “Set availability” after creating service.  
- Buffer settings should inform booking slot generation (Step 08).

### Step 10: Public Display Components

- `ServiceCard` component for profile and link-in-bio pages (title, price, CTA).  
- Use `formatCurrency` helper to show price from cents.  
- If packages exist, show “Packages from $X/session.”  
- For Growth Plan, show recommended upsell copy (AI generated) as highlight.

### Step 11: Growth & Studio Hooks

- Growth plan: AI copy suggestions, dynamic upsell, cross-sell service banners.  
- Studio plan: add `team_service` flag for multi-tutor offerings, future scheduling.  
- Display upgrade teaser card within services page for Professional users.

### Step 12: Analytics

- On service view/book events, log to `ad_performance` (later).  
- Track `service_created`, `service_updated`, `service_published` events.  
- Use PostHog/Segment event helper.

### Step 13: Accessibility & Responsiveness

- Multi-step form should support keyboard navigation; ensure focus moves on step change.  
- Provide `aria-live` for save status (“Service saved”).  
- On mobile, show simplified table (cards) rather than wide table.

## Testing Checklist

- [ ] Tutor can create, edit, delete (or deactivate) services.  
- [ ] Validation ensures positive duration, currency, and sanitized slug.  
- [ ] Session packages tie to correct service and adjust totals automatically.  
- [ ] Service appears on profile and link-in-bio preview after creation.  
- [ ] Visibility toggle hides service from public pages but keeps for tutor.  
- [ ] Buffer settings persist and reflect in booking availability (once implemented).  
- [ ] Stripe sync flag set (to be consumed next phase).  
- [ ] Growth/Studio upgrade prompts show/hide based on plan.  
- [ ] Lighthouse accessibility score ≥ 90 for `/services`.

## AI Tool Prompts

### Build Service Form
```
Create a multi-step service creation form using React, react-hook-form, shadcn/ui, and zod.
Steps: Basics, Pricing, Packages.
Include validation, default values, and submit handler that calls a server action.
```

### Session Package Dialog
```
Generate a React component for managing session packages:
- Fields: name, sessions, minutes per session, price, expiration
- Auto-calc total minutes and per-session price
- Integrate with Supabase server action to save templates
```

### Services Table
```
Build a responsive table listing services with columns:
Name, Type, Duration, Price, Status, Updated.
Include action menu (edit, duplicate, deactivate) and mobile card layout fallback.
Use shadcn/ui table primitives.
```

## Common Gotchas

- **Currency vs. price**: Always store cents in DB to avoid floating point issues; display using helper.  
- **Slug collisions**: Ensure slug uniqueness (append `-2` if existing).  
- **Deleting services**: Hard delete can break historical bookings—prefer soft deactivation.  
- **Packages vs. availability**: Don’t allow package purchase if service is inactive.  
- **RLS**: Verify policies allow tutors to manage only their own services and packages (already defined).

## Next Steps

1. Implement **07-stripe-integration.md** to handle payment flows and sync service prices.  
2. Follow with **08-booking-system.md** to make services bookable.  
3. Update link-in-bio CTA buttons to use service slugs.  
4. Add marketing copy generator (Growth Plan) once AI integration ready.

## Success Criteria

✅ Tutors can manage a catalog of services with accurate pricing and availability settings  
✅ Session packages tie into services for prepaid bundles  
✅ Public pages and booking flow reflect latest service offerings  
✅ Stripe sync hooks primed for next phase  
✅ Growth/Studio upsell messaging integrated in services workflow

**Estimated Time**: 3-4 hours

