# HawkScan DAST Security Scanning Workflow
# Runs dynamic application security testing against the application
# Reports available in StackHawk dashboard for Google Verification

name: DAST Security Scan

on:
  # Run on pull requests to main
  pull_request:
    branches: [main]

  # Weekly scheduled scan (Sunday at midnight UTC)
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - authenticated
          - full

env:
  NODE_VERSION: '20'
  WORKING_DIR: ./app

jobs:
  dast-scan:
    name: HawkScan DAST
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Build application
        working-directory: ${{ env.WORKING_DIR }}
        env:
          # Minimal env vars for build (non-functional, just for compilation)
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_APP_URL: http://localhost:3000
        run: npm run build

      - name: Start application server
        working-directory: ${{ env.WORKING_DIR }}
        env:
          # Test environment variables
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.TEST_SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.TEST_STRIPE_PUBLISHABLE_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.TEST_STRIPE_SECRET_KEY }}
          NEXT_PUBLIC_APP_URL: http://localhost:3000
        run: |
          npm start &
          echo "Waiting for server to start..."
          sleep 10

      - name: Wait for application to be ready
        run: |
          echo "Checking application health..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "Application is ready!"
              break
            fi
            echo "Attempt $i/30: Waiting for application..."
            sleep 5
          done

      - name: Create reports directory
        working-directory: ${{ env.WORKING_DIR }}
        run: mkdir -p reports

      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@v2
        with:
          apiKey: ${{ secrets.HAWK_API_KEY }}
          configurationFiles: ${{ env.WORKING_DIR }}/stackhawk.yml
          codeScanningAlerts: true
          githubToken: ${{ secrets.GITHUB_TOKEN }}
        env:
          APP_ENV: CI
          HOST: http://localhost:3000
          HAWKSCAN_APP_ID: ${{ secrets.HAWKSCAN_APP_ID }}
          # For authenticated scanning
          HAWKSCAN_TUTOR_EMAIL: ${{ secrets.HAWKSCAN_TUTOR_EMAIL }}
          HAWKSCAN_TUTOR_PASSWORD: ${{ secrets.HAWKSCAN_TUTOR_PASSWORD }}
          AUTH_ENABLED: ${{ github.event.inputs.scan_type == 'authenticated' || github.event.inputs.scan_type == 'full' }}

      - name: Upload DAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hawkscan-security-report-${{ github.run_number }}
          path: |
            ${{ env.WORKING_DIR }}/reports/
          retention-days: 90

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: ${{ env.WORKING_DIR }}/reports/hawkscan-report.sarif

  # Summary job for PR status checks
  scan-summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    needs: dast-scan
    if: always()

    steps:
      - name: Check scan results
        run: |
          if [ "${{ needs.dast-scan.result }}" == "success" ]; then
            echo "DAST scan completed successfully"
            echo "View detailed results in the StackHawk dashboard"
          else
            echo "DAST scan completed with issues"
            echo "Review findings in the StackHawk dashboard before merging"
          fi
